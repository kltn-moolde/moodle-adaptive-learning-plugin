<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Logs</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    .log-table {
        font-size: 0.9rem;
    }
    .log-row:hover {
        background-color: #f8f9fa;
    }
    .activity-badge {
        font-size: 0.8rem;
    }
    .time-badge {
        font-size: 0.75rem;
    }
    .filter-section {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
  </style>
</head>
<body>
<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-md-12">
      <!-- Header -->
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h3><i class="fas fa-chart-line"></i> User Activity Logs</h3>
          <div>
            <a th:href="@{/lti/dashboard(token=${token})}" class="btn btn-secondary btn-sm">
              <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
            <button id="refreshBtn" class="btn btn-primary btn-sm ms-2">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </div>
        </div>
      </div>

      <!-- Filter Section -->
      <div class="filter-section">
        <div class="row">
          <div class="col-md-3">
            <label for="courseSelect" class="form-label">Course ID:</label>
            <input type="text" id="courseSelect" class="form-control"
                   th:value="${courseId}" placeholder="Enter course ID">
          </div>
          <div class="col-md-3">
            <label for="moduleFilter" class="form-label">Module:</label>
            <select id="moduleFilter" class="form-select">
              <option value="">All Modules</option>
            </select>
          </div>
          <div class="col-md-3">
            <label for="actionFilter" class="form-label">Action:</label>
            <select id="actionFilter" class="form-select">
              <option value="">All Actions</option>
            </select>
          </div>
          <div class="col-md-3">
            <label for="userFilter" class="form-label">User:</label>
            <select id="userFilter" class="form-select">
              <option value="">All Users</option>
            </select>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-md-12">
            <button id="filterBtn" class="btn btn-success">
              <i class="fas fa-filter"></i> Apply Filters
            </button>
            <button id="clearFiltersBtn" class="btn btn-outline-secondary ms-2">
              <i class="fas fa-times"></i> Clear Filters
            </button>
          </div>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title text-primary">Total Logs</h5>
              <h3 id="totalLogs" class="text-primary">0</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title text-success">Active Users</h5>
              <h3 id="activeUsers" class="text-success">0</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title text-warning">Modules</h5>
              <h3 id="totalModules" class="text-warning">0</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title text-info">Actions</h5>
              <h3 id="totalActions" class="text-info">0</h3>
            </div>
          </div>
        </div>
      </div>

      <!-- Logs Table -->
      <div class="card">
        <div class="card-header">
          <h5><i class="fas fa-table"></i> Activity Logs</h5>
        </div>
        <div class="card-body">
          <div id="loading" class="text-center" style="display: none;">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>

          <div id="noLogs" class="text-center text-muted" style="display: none;">
            <i class="fas fa-info-circle fa-2x mb-3"></i>
            <p>No logs found for the selected criteria.</p>
          </div>

          <div class="table-responsive">
            <table class="table table-hover log-table" id="logsTable">
              <thead class="table-dark">
              <tr>
                <th>Time</th>
                <th>User</th>
                <th>Module</th>
                <th>Action</th>
                <th>Information</th>
                <th>IP Address</th>
              </tr>
              </thead>
              <tbody id="logsTableBody">
              <!-- Logs will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
  const token = /*[[${token}]]*/ '';
  let allLogs = [];
  let filteredLogs = [];

  // Load logs on page load
  document.addEventListener('DOMContentLoaded', function() {
      loadLogs();
  });

  // Event listeners
  document.getElementById('refreshBtn').addEventListener('click', loadLogs);
  document.getElementById('filterBtn').addEventListener('click', applyFilters);
  document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);

  function loadLogs() {
      const courseId = document.getElementById('courseSelect').value || '1';
      const loading = document.getElementById('loading');
      const noLogs = document.getElementById('noLogs');
      const tableBody = document.getElementById('logsTableBody');

      loading.style.display = 'block';
      noLogs.style.display = 'none';
      tableBody.innerHTML = '';

      fetch(`/lti/api/logs?token=${token}&courseId=${courseId}`)
          .then(response => response.json())
          .then(data => {
              allLogs = data;
              filteredLogs = data;
              populateFilters();
              displayLogs();
              updateStats();
          })
          .catch(error => {
              console.error('Error loading logs:', error);
              noLogs.style.display = 'block';
          })
          .finally(() => {
              loading.style.display = 'none';
          });
  }

  function populateFilters() {
      const moduleFilter = document.getElementById('moduleFilter');
      const actionFilter = document.getElementById('actionFilter');
      const userFilter = document.getElementById('userFilter');

      // Clear existing options
      moduleFilter.innerHTML = '<option value="">All Modules</option>';
      actionFilter.innerHTML = '<option value="">All Actions</option>';
      userFilter.innerHTML = '<option value="">All Users</option>';

      // Get unique values
      const modules = [...new Set(allLogs.map(log => log.moduleName).filter(Boolean))];
      const actions = [...new Set(allLogs.map(log => log.action).filter(Boolean))];
      const users = [...new Set(allLogs.map(log => log.fullName).filter(Boolean))];

      // Populate filters
      modules.forEach(module => {
          const option = document.createElement('option');
          option.value = module;
          option.textContent = module;
          moduleFilter.appendChild(option);
      });

      actions.forEach(action => {
          const option = document.createElement('option');
          option.value = action;
          option.textContent = action;
          actionFilter.appendChild(option);
      });

      users.forEach(user => {
          const option = document.createElement('option');
          option.value = user;
          option.textContent = user;
          userFilter.appendChild(option);
      });
  }

  function applyFilters() {
      const moduleFilter = document.getElementById('moduleFilter').value;
      const actionFilter = document.getElementById('actionFilter').value;
      const userFilter = document.getElementById('userFilter').value;

      filteredLogs = allLogs.filter(log => {
          return (!moduleFilter || log.moduleName === moduleFilter) &&
                 (!actionFilter || log.action === actionFilter) &&
                 (!userFilter || log.fullName === userFilter);
      });

      displayLogs();
      updateStats();
  }

  function clearFilters() {
      document.getElementById('moduleFilter').value = '';
      document.getElementById('actionFilter').value = '';
      document.getElementById('userFilter').value = '';

      filteredLogs = allLogs;
      displayLogs();
      updateStats();
  }

  function displayLogs() {
    const tableBody = document.getElementById('logsTableBody');
    const noLogs = document.getElementById('noLogs');

    tableBody.innerHTML = '';

    if (filteredLogs.length === 0) {
        noLogs.style.display = 'block';
        return;
    }

    noLogs.style.display = 'none';

    filteredLogs.forEach(log => {
        const row = document.createElement('tr');
        row.className = 'log-row';

        const timeStr = log.timecreated
            ? new Date(log.timecreated * 1000).toLocaleString()
            : 'N/A';

        const username = log.username || 'Unknown';

        row.innerHTML = `
            <td>
                <span class="badge bg-secondary time-badge">${timeStr}</span>
            </td>
            <td>
                <strong>${username}</strong>
            </td>
            <td>
                <span class="badge bg-primary activity-badge">${log.component || 'N/A'}</span>
            </td>
            <td>
                <span class="badge bg-success activity-badge">${log.action || 'N/A'}</span>
            </td>
            <td>
                <small>${log.target || 'N/A'}</small>
            </td>
            <td>
                <code>N/A</code> <!-- Vì JSON không có ip -->
            </td>
        `;

        tableBody.appendChild(row);
    });
}


  function updateStats() {
      document.getElementById('totalLogs').textContent = filteredLogs.length;

      const uniqueUsers = new Set(filteredLogs.map(log => log.userId));
      document.getElementById('activeUsers').textContent = uniqueUsers.size;

      const uniqueModules = new Set(filteredLogs.map(log => log.moduleName).filter(Boolean));
      document.getElementById('totalModules').textContent = uniqueModules.size;

      const uniqueActions = new Set(filteredLogs.map(log => log.action).filter(Boolean));
      document.getElementById('totalActions').textContent = uniqueActions.size;
  }
</script>
</body>
</html>