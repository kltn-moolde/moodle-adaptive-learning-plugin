sequenceDiagram
    autonumber
    actor Student as Sinh viên
    participant Moodle as Moodle LMS
    participant Kong as Kong Gateway
    participant LTIS as LTI Service
    participant React as ReactJS App
    participant Rec as Recommend Service
    participant Mongo as MongoDB

    Note over Student, LTIS: Bước 1: Khởi tạo & Xác thực (LTI Launch)
    Student->>Moodle: Click "Gợi ý học tập"
    Moodle->>Kong: Gửi yêu cầu OIDC (JWT Token)
    Kong->>LTIS: Chuyển tiếp yêu cầu xác thực
    Note right of LTIS: Thực hiện Handshake & Validate JWT
    LTIS->>React: Chuyển hướng & Khởi tạo Interface

    Note over React, Moodle: Bước 2: Tổng hợp dữ liệu (State Encoding)
    React->>Rec: GET /recommend
    Rec->>Moodle: Gọi API lấy Progress & Grades
    Moodle-->>Rec: Trả về dữ liệu điểm số/trạng thái

    Note over Rec: Bước 3: Xếp hạng Top-k (Top-k Ranking)
    Rec->>Rec: Encode State (Chuyển đổi thành Vector)
    Rec->>Rec: Tính Q-Values & Lọc Top-k hành động
    Rec-->>React: Trả về JSON (Danh sách gợi ý)
    React-->>Student: Hiển thị Dashboard Top-k

    Note over Student, Moodle: Bước 4: Điều hướng & Học tập
    Student->>React: Chọn 1 bài tập trong Top-k
    React->>Moodle: Redirect về trang bài tập (Activity URL)
    Student->>Moodle: Thực hiện làm bài & Nộp bài
    Moodle->>Moodle: Chấm điểm & Lưu trữ nội bộ

    Note over Moodle, Mongo: Bước 5: Webhook & Cập nhật AI
    Moodle->>Rec: Trigger Webhook (User, Activity, Grade)
    Rec->>Rec: Tính Reward & Cập nhật Q-Value
    Rec->>Mongo: Lưu trữ Q-Table mới