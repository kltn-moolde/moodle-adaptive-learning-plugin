# Monitoring and Logging Configuration

# NGINX status page for monitoring
server {
    listen 8081;
    server_name localhost;
    
    # Basic authentication for status page (optional)
    # auth_basic "NGINX Status";
    # auth_basic_user_file /etc/nginx/.htpasswd;
    
    location /nginx_status {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        allow ::1;
        deny all;
    }
    
    location /health {
        access_log off;
        return 200 '{"status":"ok","service":"nginx-gateway","timestamp":"$time_iso8601","uptime":"$upstream_response_time"}';
        add_header Content-Type application/json;
    }
    
    # Detailed health check with upstream status
    location /health/detailed {
        access_log off;
        return 200 '{"status":"ok","service":"nginx-gateway","timestamp":"$time_iso8601","upstreams":{"user-service":"$upstream_addr","course-service":"available","common-service":"available","lti-service":"available"}}';
        add_header Content-Type application/json;
    }
    
    # Configuration dump (for debugging)
    location /config {
        access_log off;
        allow 127.0.0.1;
        deny all;
        return 200 '{"nginx_version":"$nginx_version","server_name":"$server_name","server_port":"$server_port","timestamp":"$time_iso8601"}';
        add_header Content-Type application/json;
    }
}

# Log format for JSON logging (ELK stack compatible)
log_format json_combined escape=json
    '{'
    '"time_local":"$time_local",'
    '"remote_addr":"$remote_addr",'
    '"remote_user":"$remote_user",'
    '"request":"$request",'
    '"status": "$status",'
    '"body_bytes_sent":"$body_bytes_sent",'
    '"request_time":"$request_time",'
    '"http_referrer":"$http_referer",'
    '"http_user_agent":"$http_user_agent",'
    '"upstream_addr":"$upstream_addr",'
    '"upstream_status":"$upstream_status",'
    '"upstream_response_time":"$upstream_response_time",'
    '"upstream_connect_time":"$upstream_connect_time",'
    '"upstream_header_time":"$upstream_header_time"'
    '}';

# Access log with JSON format
access_log logs/access.json json_combined;

# Error log with custom format
error_log logs/error.log warn;
