# Load Balancing Configuration
# Advanced load balancing with health checks

# Health check configuration
upstream user-service-cluster {
    # Load balancing method
    least_conn;  # or ip_hash, hash, random
    
    # Multiple instances for scalability
    server 127.0.0.1:8086 max_fails=3 fail_timeout=30s weight=1;
    # server 127.0.0.1:8186 max_fails=3 fail_timeout=30s weight=1;  # Additional instance
    
    # Backup server
    # server 127.0.0.1:8286 backup;
    
    keepalive 32;
    keepalive_requests 100;
    keepalive_timeout 60s;
}

upstream course-service-cluster {
    least_conn;
    
    server 127.0.0.1:8084 max_fails=3 fail_timeout=30s weight=1;
    # server 127.0.0.1:8184 max_fails=3 fail_timeout=30s weight=1;
    
    keepalive 32;
    keepalive_requests 100;
    keepalive_timeout 60s;
}

upstream common-service-cluster {
    least_conn;
    
    server 127.0.0.1:8087 max_fails=3 fail_timeout=30s weight=1;
    # server 127.0.0.1:8187 max_fails=3 fail_timeout=30s weight=1;
    
    keepalive 32;
    keepalive_requests 100;
    keepalive_timeout 60s;
}

upstream lti-service-cluster {
    least_conn;
    
    server 127.0.0.1:8082 max_fails=3 fail_timeout=30s weight=1;
    # server 127.0.0.1:8182 max_fails=3 fail_timeout=30s weight=1;
    
    keepalive 32;
    keepalive_requests 100;
    keepalive_timeout 60s;
}

# Frontend cluster (multiple instances for high availability)
upstream frontend-cluster {
    least_conn;
    
    server 127.0.0.1:3000 max_fails=3 fail_timeout=30s weight=1;
    # server 127.0.0.1:3001 max_fails=3 fail_timeout=30s weight=1;  # Additional instance
    
    keepalive 32;
    keepalive_requests 100;
    keepalive_timeout 60s;
}
